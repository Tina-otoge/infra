http_domain: laffey.tina.moe
public_ip: 198.27.82.171
graylog_url: https://graylog.tina.moe/


user_tasks:
  - prometheus
  - loki


packages:
  - ufw


firewall:
  default: allow
  rules:
    - port: "{{ prometheus_node_exporter_port }}"
      action: deny
    - port: "{{ prometheus_node_exporter_port }}"
      from: "{{ public_ip }}"
      action: allow

    - port: "{{ prometheus_port }}"
      action: deny
    - port: "{{ prometheus_port }}"
      from: "{{ public_ip }}"
      action: allow

    - port: "{{ caddy_admin_port }}"
      action: deny
    - port: "{{ caddy_admin_port }}"
      from: "{{ public_ip }}"
      action: allow

    - port: "{{ loki_port }}"
      action: deny
    - port: "{{ loki_port }}"
      from: "{{ public_ip }}"
      action: allow


users:
  - akeyro
  - koneko
  - noa
  - platea
  - reaxt
  - sayaka
  - test

users_admins:
  - tina

skel:
  - www
  - wwws/example.com


caddy_prometheus: true
caddy_global_extra: |
  admin :{{ caddy_admin_port }}

# caddy_logs_outputs:
#   graylog: net localhost:5555

caddy_extra: |
  import users.d/*.conf

caddy_entries:
  - domain: "{{ http_domain }}"
    root: /home/tina/wwws/laffey
    file: tina
    reverses:
      - path: "{{ cockpit_url_root }}"
        to: 9090
      - path: "{{ flood_url_root }}"
        to: 3000
      - path: /qbit
        remove_path: true
        to: "{{ qbittorrent_webui_port }}"
    extra: |
      @userdir {
        path_regexp userdir ^/~(\w+)/
      }
      handle @userdir {
        uri strip_prefix /~{re.userdir.1}/
        file_server browse {
          root /home/{re.userdir.1}/www/
        }
      }
  - domain: kuma.tina.moe
    file: tina
    reverses:
      - to: "{{ uptime_kuma_port }}"
  - domain: grafana.tina.moe
    file: tina
    reverses:
      - to: "{{ grafana_port }}"
  - domain: tina.moe
    root: /home/tina/wwws/tina
    file: tina
    reverses:
      - path: /infra
        to: "{{ infra_webui_port }}"
        remove_path: true
    extra: |
      handle_path /private/* {
        root * /home/tina/wwws/private
        file_server
      }
      redir /private /private/
  - domain: couscous.tina.moe wiki.couscous.tina.moe
    robots: false
    file: tina
    reverses:
      - to: 57348
  - domain: pixiv.tina.moe
    file: tina
    robots: false
    reverses:
      - to: 8282
    # extra: |
    #   @artworks path_regexp ^/\w{2}/artworks/(\d+)
    #   handle @artworks {
    #     redir /artworks/{re.artworks.1}
    #   }
  - domain: www.pixiv.tina.moe
    file: tina
    extra: |
      redir https://pixiv.tina.moe{uri}
  - domain: taiko.tina.moe
    file: tina
    reverses:
      - to: 5000

  - domain: six.savatier.fr
    root: /home/tina/wwws/six
    file: tina_six
    extra: |
      redir https://six.tina.moe{uri}
  - domain: six.tina.moe
    root: /home/tina/wwws/six
    file: tina_six
    reverses:
      - path: /jellyfin
        to: "{{ jellyfin_port }}"



paths:
  /srv/media:
    owner: tina


tunnels:
  # node_exporter
  - user: tina
    remote_host: turbo.tina.moe
    remote_port: 9100
    local_port: 9101
  - user: tina
    remote_host: nagato.lan
    remote_port: 9100
    local_port: 9102


repositories:
  - src: https://github.com/Tina-otoge/infra-webui


user_services:
  infra_webui:
    workdir: "{{ repositories_dir }}/infra-webui"
    cmd: |
      {{ python_setup }}
      pip install gunicorn
      gunicorn src:app -b {{ loopback_ip }}:{{ infra_webui_port }}
  couscous_infra:
    workdir: "{{ repositories_dir }}/couscous"
    cmd: "{{ compose_setup }}"
  six:
    workdir: "{{ compose_dir }}/six"
    cmd: "{{ compose_setup }}"
    depend: home-tina-mnt-turbo.mount
  flood:
    workdir: "{{ compose_dir }}/flood"
    cmd: |
      rm -rfv {{ ansible_user_dir }}/.config/flood/rtorrent/rtorrent.sock
      {{ compose_setup }}
  pixivfe:
    workdir: "{{ repositories_dir }}/PixivFE"
    cmd: |
      ./patch/patch.sh
      {{ compose_setup }}
  taiko:
    workdir: "{{ repositories_dir }}/TaikoLocalServer"
    cmd: |
      chmod +x TaikoLocalServer
      ./TaikoLocalServer


quadlets:
  prometheus:
    image: prom/prometheus
    tag: latest
    user: "{{ ansible_user_id }}"
    network: host
    exec: |
      --config.file=/etc/prometheus/prometheus.yml
      --storage.tsdb.path=/prometheus
      --web.listen-address="{{ loopback_ip }}:{{ prometheus_port }}"
    volumes:
      - "{{ ansible_user_dir }}/.config/prometheus:/etc/prometheus"
      - "{{ ansible_user_dir }}/.local/share/prometheus:/prometheus"
  grafana:
    image: grafana/grafana-oss
    tag: main
    network: host
    env:
      GF_SERVER_HTTP_ADDR: "{{ loopback_ip }}"
      GF_SERVER_HTTP_PORT: "{{ grafana_port }}"
    user: "{{ ansible_user_id }}"
    volumes:
      - "{{ ansible_user_dir }}/.local/share/grafana:/var/lib/grafana"
  loki:
    image: grafana/loki
    tag: main
    user: 0
    ports:
      - "{{ loki_port }}:3100"
    volumes:
      - "{{ ansible_user_dir }}/.config/loki:/etc/loki"
      - "{{ ansible_user_dir }}/.local/share/loki:/loki"
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent
    tag: latest
    ports:
      - "{{ loopback_ip }}:{{ qbittorrent_webui_port }}:{{ qbittorrent_webui_port }}"
    volumes:
      - "{{ ansible_user_dir }}/.config/qbittorrent:/config"
      - "{{ ansible_user_dir }}/mnt/sakura-private/Downloads/torrents:/mnt/downloads"
    env: "{{ linuxserver_env }}"
  kuma:
    image: louislam/uptime-kuma
    tag: latest
    ports:
      - "{{ loopback_ip }}:{{ uptime_kuma_port }}:{{ uptime_kuma_port }}"
    volumes:
      - "{{ ansible_user_dir }}/.local/share/uptime-kuma:/app/data"


compose_services:
  - six
  - flood


user_mounts:
  - what: tina@turbo.tina.moe:/
    where: "{{ ansible_user_dir }}/mnt/turbo"
    type: fuse.sshfs
    description: Savatier Home Freebox VM
    test: "{{ ansible_user_dir }}/mnt/turbo/mnt/Freebox"


torrents_dir: "{{ ansible_user_dir }}/mnt/sakura-private/Downloads/torrents"
