- package: name=smartmontools

- name: Create service files smart check job
  include_role:
    name: common
    tasks_from: create_service
  vars:
    service_name: smart-check
    service_schedule: weekly
    service_script: |
      status=0

      if [ -f /etc/monitoring-webhook.env ]; then
        source /etc/monitoring-webhook.env
      fi

      for drive in $(smartctl --scan | awk '{print $1}'); do
        echo "Checking SMART status for $drive"
        smartctl -H $drive
        if [ $? -eq 0 ]; then
          echo "SMART status for $drive is OK."
          continue
        fi
        status=1
        details=$(smartctl -a $drive)
        echo "SMART status for $drive indicates a problem:"
        echo "$details"
        if [ -n "$WEBHOOK_URL" ]; then
          msg=$(echo "$details" | sed 's/"/\\"/g' | sed "s/'/\\'/g" | tr -d '\n')
          curl -X POST -H 'Content-type: application/json' -d '{"content":"SMART alert for drive '"$drive"': '"$msg"'"}' $WEBHOOK_URL
        fi
      done

      exit $status
